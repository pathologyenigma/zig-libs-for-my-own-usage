<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>math\matrix.zig - source view</title>
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAgklEQVR4AWMYWuD7EllJIM4G4g4g5oIJ/odhOJ8wToOxSTXgNxDHoeiBMfA4+wGShjyYOCkG/IGqWQziEzYAoUAeiF9D5U+DxEg14DRU7jWIT5IBIOdCxf+A+CQZAAoopEB7QJwBCBwHiip8UYmRdrAlDpIMgApwQZNnNii5Dq0MBgCxxycBnwEd+wAAAABJRU5ErkJggg=="/>
    <style>
      body{
        font-family: system-ui, -apple-system, Roboto, "Segoe UI", sans-serif;
        margin: 0;
        line-height: 1.5;
      }

      pre > code {
        display: block;
        overflow: auto;
        line-height: normal;
        margin: 0em;
      }
      .tok-kw {
          color: #333;
          font-weight: bold;
      }
      .tok-str {
          color: #d14;
      }
      .tok-builtin {
          color: #005C7A;
      }
      .tok-comment {
          color: #545454;
          font-style: italic;
      }
      .tok-fn {
          color: #900;
          font-weight: bold;
      }
      .tok-null {
          color: #005C5C;
      }
      .tok-number {
          color: #005C5C;
      }
      .tok-type {
          color: #458;
          font-weight: bold;
      }
      pre {
        counter-reset: line;
      }
      pre .line:before {
        counter-increment: line;
        content: counter(line);
        display: inline-block;
        padding-right: 1em;
        width: 2em;
        text-align: right;
        color: #999;
      }
      
      .line {
        width: 100%;
        display: inline-block;
      }
      .line:target {
        border-top: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
        background: #fafafa;
      }

      @media (prefers-color-scheme: dark) {
        body{
            background:#222;
            color: #ccc;
        }
        pre > code {
            color: #ccc;
            background: #222;
            border: unset;
        }
        .line:target {
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
            background: #333;
        }
        .tok-kw {
            color: #eee;
        }
        .tok-str {
            color: #2e5;
        }
        .tok-builtin {
            color: #ff894c;
        }
        .tok-comment {
            color: #aa7;
        }
        .tok-fn {
            color: #B1A0F8;
        }
        .tok-null {
            color: #ff8080;
        }
        .tok-number {
            color: #ff8080;
        }
        .tok-type {
            color: #68f;
        }
      }
    </style>
</head>
<body>
<pre><code><span class="line" id="L1"><span class="tok-kw">const</span> std = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;std&quot;</span>);</span>
<span class="line" id="L2"><span class="tok-kw">const</span> testing = std.testing;</span>
<span class="line" id="L3"></span>
<span class="line" id="L4"><span class="tok-comment">/// a matrix implementation based on standard library vector type</span></span>
<span class="line" id="L5"><span class="tok-comment">/// only support numberics type for T</span></span>
<span class="line" id="L6"><span class="tok-comment">/// type check not implemented for type definitions</span></span>
<span class="line" id="L7"><span class="tok-comment">/// but will be check when calling init function</span></span>
<span class="line" id="L8"><span class="tok-comment">/// a print function is provided for debug usage</span></span>
<span class="line" id="L9"><span class="tok-comment">/// not thread safe, but you can only got one pointer at a time</span></span>
<span class="line" id="L10"><span class="tok-comment">/// thread safe implementation will be available when I add ownership check utils to my library</span></span>
<span class="line" id="L11"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">Matrix</span>(<span class="tok-kw">comptime</span> row: <span class="tok-type">comptime_int</span>, <span class="tok-kw">comptime</span> col: <span class="tok-type">comptime_int</span>, <span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L12">    <span class="tok-kw">const</span> typeInfo = <span class="tok-builtin">@typeInfo</span>(T);</span>
<span class="line" id="L13">    <span class="tok-kw">switch</span> (typeInfo) {</span>
<span class="line" id="L14">        .Int, .Float, .Bool =&gt; {},</span>
<span class="line" id="L15">        <span class="tok-kw">else</span> =&gt; {</span>
<span class="line" id="L16">            <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;should only numeric types&quot;</span>);</span>
<span class="line" id="L17">        },</span>
<span class="line" id="L18">    }</span>
<span class="line" id="L19">    <span class="tok-kw">return</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L20">        <span class="tok-kw">const</span> RowType = <span class="tok-builtin">@Vector</span>(col, T);</span>
<span class="line" id="L21">        <span class="tok-kw">const</span> Self = <span class="tok-builtin">@This</span>();</span>
<span class="line" id="L22">        <span class="tok-kw">const</span> defalutAllocator: std.mem.Allocator = std.heap.page_allocator;</span>
<span class="line" id="L23">        val: [row]RowType,</span>
<span class="line" id="L24">        <span class="tok-kw">const</span> InitArgsCheckResult = <span class="tok-kw">enum</span> {</span>
<span class="line" id="L25">            StructStruct,</span>
<span class="line" id="L26">            StructArray,</span>
<span class="line" id="L27">            StructNumberic,</span>
<span class="line" id="L28">        };</span>
<span class="line" id="L29">        <span class="tok-kw">const</span> InitArgsCheckFailedError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L30">            InvalidFormat,</span>
<span class="line" id="L31">            AmountNotMatch,</span>
<span class="line" id="L32">            InnerTypeNotSupported,</span>
<span class="line" id="L33">        };</span>
<span class="line" id="L34">        <span class="tok-comment">/// the type of the transpose one</span></span>
<span class="line" id="L35">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> TransposeMatrix = Matrix(col, row, T);</span>
<span class="line" id="L36">        <span class="tok-comment">/// the type of column vector</span></span>
<span class="line" id="L37">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> ColVector = <span class="tok-builtin">@Vector</span>(row, T);</span>
<span class="line" id="L38">        <span class="tok-comment">/// check the if the input matrix is valid type</span></span>
<span class="line" id="L39">        <span class="tok-comment">/// if the input is not matrix but having row as comptime field</span></span>
<span class="line" id="L40">        <span class="tok-comment">/// this function may not works well, so it should be private</span></span>
<span class="line" id="L41">        <span class="tok-comment">/// and only be used when the input is a matrix</span></span>
<span class="line" id="L42">        <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">isValidMulMatrix</span>(<span class="tok-kw">comptime</span> m: <span class="tok-type">type</span>) <span class="tok-type">bool</span> {</span>
<span class="line" id="L43">            <span class="tok-comment">// only support matrix pointer</span>
</span>
<span class="line" id="L44">            <span class="tok-comment">// cause the matrix's constructor returns a pointer</span>
</span>
<span class="line" id="L45">            <span class="tok-comment">// don't trying to dereference it yourself</span>
</span>
<span class="line" id="L46">            <span class="tok-kw">if</span> (<span class="tok-builtin">@typeInfo</span>(m) != .Pointer) <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L47">            <span class="tok-comment">// if the inner type of the pointer is not matrix</span>
</span>
<span class="line" id="L48">            <span class="tok-comment">// will get a compile error like this:</span>
</span>
<span class="line" id="L49">            <span class="tok-comment">// type xxx not have a field call col_size</span>
</span>
<span class="line" id="L50">            <span class="tok-kw">return</span> <span class="tok-builtin">@typeInfo</span>(m).Pointer.child.row_size() == col;</span>
<span class="line" id="L51">        }</span>
<span class="line" id="L52">        <span class="tok-kw">const</span> RowOrCol = <span class="tok-kw">enum</span> { row, col };</span>
<span class="line" id="L53">        <span class="tok-kw">const</span> Vector = <span class="tok-kw">union</span>(RowOrCol) { row: RowType, col: ColVector };</span>
<span class="line" id="L54">        <span class="tok-comment">/// implementation for dot multiplication for vectors</span></span>
<span class="line" id="L55">        <span class="tok-comment">/// this function should only be used when the size of the vector is checked</span></span>
<span class="line" id="L56">        <span class="tok-comment">/// for some reason the input type could only be col vector or row vector</span></span>
<span class="line" id="L57">        <span class="tok-comment">/// and should be the same type</span></span>
<span class="line" id="L58">        <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">dot</span>(vec1: Vector, vec2: Vector) T {</span>
<span class="line" id="L59">            <span class="tok-kw">if</span> (<span class="tok-builtin">@as</span>(RowOrCol, vec1) != <span class="tok-builtin">@as</span>(RowOrCol, vec2) <span class="tok-kw">and</span> row != col) <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;vec1 and vec2 should be the same size&quot;</span>);</span>
<span class="line" id="L60">            <span class="tok-kw">var</span> res: T = <span class="tok-number">0</span>;</span>
<span class="line" id="L61">            <span class="tok-comment">// this is weird</span>
</span>
<span class="line" id="L62">            <span class="tok-comment">// but if you try not to using switch</span>
</span>
<span class="line" id="L63">            <span class="tok-comment">// you still need to write the same code twice</span>
</span>
<span class="line" id="L64">            <span class="tok-comment">// cause they are different types</span>
</span>
<span class="line" id="L65">            <span class="tok-kw">switch</span> (vec1) {</span>
<span class="line" id="L66">                .row =&gt; |r| {</span>
<span class="line" id="L67">                    <span class="tok-kw">var</span> index: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L68">                    <span class="tok-kw">while</span> (index &lt; col) : (index += <span class="tok-number">1</span>) {</span>
<span class="line" id="L69">                        res += r[index] * vec2.row[index];</span>
<span class="line" id="L70">                    }</span>
<span class="line" id="L71">                },</span>
<span class="line" id="L72">                .col =&gt; |c| {</span>
<span class="line" id="L73">                    <span class="tok-kw">var</span> index: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L74">                    <span class="tok-kw">while</span> (index &lt; row) : (index += <span class="tok-number">1</span>) {</span>
<span class="line" id="L75">                        res += c[index] * vec2.row[index];</span>
<span class="line" id="L76">                    }</span>
<span class="line" id="L77">                },</span>
<span class="line" id="L78">            }</span>
<span class="line" id="L79">            <span class="tok-kw">return</span> res;</span>
<span class="line" id="L80">        }</span>
<span class="line" id="L81">        <span class="tok-comment">// like the trait in dlang or c++</span>
</span>
<span class="line" id="L82">        <span class="tok-comment">// but in zig we can check more things about it</span>
</span>
<span class="line" id="L83">        <span class="tok-comment">// but this type of concept may not that readable</span>
</span>
<span class="line" id="L84">        <span class="tok-comment">// so I will change it as soon as zig support a more readable type of type concept</span>
</span>
<span class="line" id="L85">        <span class="tok-comment">// this type of comptime check is fine, but using anytype for arg's type is not that readable</span>
</span>
<span class="line" id="L86">        <span class="tok-comment">// the trait that standard library is using is also not that readable</span>
</span>
<span class="line" id="L87">        <span class="tok-comment">/// check if the type is supported or not</span></span>
<span class="line" id="L88">        <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">init_args_check</span>(args: <span class="tok-kw">anytype</span>) Self.InitArgsCheckFailedError!Self.InitArgsCheckResult {</span>
<span class="line" id="L89">            <span class="tok-kw">const</span> ArgsType = <span class="tok-builtin">@TypeOf</span>(args);</span>
<span class="line" id="L90">            <span class="tok-kw">const</span> ArgsTypeInfo = <span class="tok-builtin">@typeInfo</span>(ArgsType);</span>
<span class="line" id="L91">            <span class="tok-kw">if</span> (ArgsTypeInfo != .Struct) {</span>
<span class="line" id="L92">                <span class="tok-kw">return</span> .InvalidFormat;</span>
<span class="line" id="L93">            }</span>
<span class="line" id="L94">            <span class="tok-kw">if</span> (ArgsTypeInfo.Struct.fields.len != col * row) {</span>
<span class="line" id="L95">                <span class="tok-kw">if</span> (<span class="tok-builtin">@typeInfo</span>(ArgsTypeInfo.Struct.fields[<span class="tok-number">0</span>].<span class="tok-type">type</span>) != .Struct) {</span>
<span class="line" id="L96">                    <span class="tok-kw">return</span> .AmountNotMatch;</span>
<span class="line" id="L97">                }</span>
<span class="line" id="L98">                <span class="tok-kw">if</span> (ArgsTypeInfo.Struct.fields.len != row) {</span>
<span class="line" id="L99">                    <span class="tok-kw">return</span> .AmountNotMatch;</span>
<span class="line" id="L100">                }</span>
<span class="line" id="L101">                <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (ArgsTypeInfo.Struct.fields) |field| {</span>
<span class="line" id="L102">                    <span class="tok-kw">switch</span> (<span class="tok-builtin">@typeInfo</span>(field.<span class="tok-type">type</span>)) {</span>
<span class="line" id="L103">                        .Struct =&gt; {</span>
<span class="line" id="L104">                            <span class="tok-kw">if</span> (<span class="tok-builtin">@typeInfo</span>(field.<span class="tok-type">type</span>).Struct.fields.len != col) {</span>
<span class="line" id="L105">                                <span class="tok-kw">return</span> .AmountNotMatch;</span>
<span class="line" id="L106">                            }</span>
<span class="line" id="L107">                            <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (<span class="tok-builtin">@typeInfo</span>(field.<span class="tok-type">type</span>).Struct.fields) |field_| {</span>
<span class="line" id="L108">                                <span class="tok-kw">switch</span> (<span class="tok-builtin">@typeInfo</span>(field_.<span class="tok-type">type</span>)) {</span>
<span class="line" id="L109">                                    .Float, .Int, .ComptimeInt, .ComptimeFloat =&gt; {</span>
<span class="line" id="L110">                                        <span class="tok-kw">continue</span>;</span>
<span class="line" id="L111">                                    },</span>
<span class="line" id="L112">                                    <span class="tok-kw">else</span> =&gt; {</span>
<span class="line" id="L113">                                        <span class="tok-kw">return</span> .InvalidFormat;</span>
<span class="line" id="L114">                                    },</span>
<span class="line" id="L115">                                }</span>
<span class="line" id="L116">                            }</span>
<span class="line" id="L117">                            <span class="tok-kw">return</span> .StructStruct;</span>
<span class="line" id="L118">                        },</span>
<span class="line" id="L119">                        .Array =&gt; {</span>
<span class="line" id="L120">                            <span class="tok-kw">if</span> (<span class="tok-builtin">@typeInfo</span>(field.<span class="tok-type">type</span>).Array.len != col) {</span>
<span class="line" id="L121">                                <span class="tok-kw">return</span> .AmountNotMatch;</span>
<span class="line" id="L122">                            }</span>
<span class="line" id="L123">                            <span class="tok-kw">switch</span> (<span class="tok-builtin">@typeInfo</span>(<span class="tok-builtin">@typeInfo</span>(field.<span class="tok-type">type</span>).Array.child)) {</span>
<span class="line" id="L124">                                .Float, .Int, .ComptimeInt, .ComptimeFloat =&gt; {</span>
<span class="line" id="L125">                                    <span class="tok-kw">return</span> .StructStruct;</span>
<span class="line" id="L126">                                },</span>
<span class="line" id="L127">                                <span class="tok-kw">else</span> =&gt; {</span>
<span class="line" id="L128">                                    <span class="tok-kw">return</span> .InnerTypeNotSupported;</span>
<span class="line" id="L129">                                },</span>
<span class="line" id="L130">                            }</span>
<span class="line" id="L131">                        },</span>
<span class="line" id="L132">                        <span class="tok-kw">else</span> =&gt; {</span>
<span class="line" id="L133">                            <span class="tok-kw">return</span> .InnerTypeNotSupported;</span>
<span class="line" id="L134">                        },</span>
<span class="line" id="L135">                    }</span>
<span class="line" id="L136">                }</span>
<span class="line" id="L137">            } <span class="tok-kw">else</span> {</span>
<span class="line" id="L138">                <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (ArgsTypeInfo.Struct.fields) |field| {</span>
<span class="line" id="L139">                    <span class="tok-kw">switch</span> (<span class="tok-builtin">@typeInfo</span>(field.<span class="tok-type">type</span>)) {</span>
<span class="line" id="L140">                        .Struct, .Array =&gt; {</span>
<span class="line" id="L141">                            <span class="tok-kw">return</span> .AmountNotMatch;</span>
<span class="line" id="L142">                        },</span>
<span class="line" id="L143">                        .Float, .Int, .ComptimeInt, .ComptimeFloat =&gt; {</span>
<span class="line" id="L144">                            <span class="tok-kw">return</span> .StructNumberic;</span>
<span class="line" id="L145">                        },</span>
<span class="line" id="L146">                        <span class="tok-kw">else</span> =&gt; {</span>
<span class="line" id="L147">                            <span class="tok-kw">return</span> .InnerTypeNotSupported;</span>
<span class="line" id="L148">                        },</span>
<span class="line" id="L149">                    }</span>
<span class="line" id="L150">                }</span>
<span class="line" id="L151">            }</span>
<span class="line" id="L152">        }</span>
<span class="line" id="L153">        <span class="tok-comment">/// init a matrix using the given values</span></span>
<span class="line" id="L154">        <span class="tok-comment">/// supported a double tuple or a single tuple</span></span>
<span class="line" id="L155">        <span class="tok-comment">/// the amount of elements should match the size of the matrix</span></span>
<span class="line" id="L156">        <span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">init</span>(args: <span class="tok-kw">anytype</span>) *Self {</span>
<span class="line" id="L157">            <span class="tok-kw">comptime</span> <span class="tok-kw">var</span> check_result = Self.init_args_check(args) <span class="tok-kw">catch</span> |e| {</span>
<span class="line" id="L158">                <span class="tok-kw">switch</span> (e) {</span>
<span class="line" id="L159">                    InitArgsCheckFailedError.InnerTypeNotSupported =&gt; {</span>
<span class="line" id="L160">                        <span class="tok-builtin">@compileError</span>(</span>
<span class="line" id="L161">                            <span class="tok-str">\\ value inside tuple is not supported</span></span>

<span class="line" id="L162">                            <span class="tok-str">\\ only supported tuple/struct, array type or numberics</span></span>

<span class="line" id="L163">                        );</span>
<span class="line" id="L164">                    },</span>
<span class="line" id="L165">                    InitArgsCheckFailedError.InvalidFormat =&gt; {</span>
<span class="line" id="L166">                        <span class="tok-builtin">@compileError</span>(</span>
<span class="line" id="L167">                            <span class="tok-str">\\ not a valid format for arguments</span></span>

<span class="line" id="L168">                            <span class="tok-str">\\ only supported format like {*, *...} or {{*,...},...}</span></span>

<span class="line" id="L169">                        );</span>
<span class="line" id="L170">                    },</span>
<span class="line" id="L171">                    InitArgsCheckFailedError.AmountNotMatch =&gt; {</span>
<span class="line" id="L172">                        <span class="tok-builtin">@compileError</span>(</span>
<span class="line" id="L173">                            <span class="tok-str">\\ not a valid amount for arguments</span></span>

<span class="line" id="L174">                            <span class="tok-str">\\ matrix should have a static size</span></span>

<span class="line" id="L175">                            <span class="tok-str">\\ if you want to auto fill</span></span>

<span class="line" id="L176">                            <span class="tok-str">\\ try using default function or fill function</span></span>

<span class="line" id="L177">                        );</span>
<span class="line" id="L178">                    },</span>
<span class="line" id="L179">                }</span>
<span class="line" id="L180">            };</span>
<span class="line" id="L181">            <span class="tok-kw">var</span> self: *Self = defalutAllocator.create(Self) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;failed to create memory&quot;</span>);</span>
<span class="line" id="L182">            <span class="tok-kw">switch</span> (check_result) {</span>
<span class="line" id="L183">                .StructNumberic =&gt; {</span>
<span class="line" id="L184">                    <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (args, <span class="tok-number">0</span>..) |v, i| {</span>
<span class="line" id="L185">                        self.val[i / col][i % col] = v;</span>
<span class="line" id="L186">                    }</span>
<span class="line" id="L187">                },</span>
<span class="line" id="L188">                <span class="tok-kw">else</span> =&gt; {</span>
<span class="line" id="L189">                    self.val = args;</span>
<span class="line" id="L190">                },</span>
<span class="line" id="L191">            }</span>
<span class="line" id="L192">            <span class="tok-kw">return</span> self;</span>
<span class="line" id="L193">        }</span>
<span class="line" id="L194">        <span class="tok-comment">/// returns a matrix that filled with zeros</span></span>
<span class="line" id="L195">        <span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">default</span>() *Self {</span>
<span class="line" id="L196">            <span class="tok-kw">return</span> Self.fill(<span class="tok-number">0</span>);</span>
<span class="line" id="L197">        }</span>
<span class="line" id="L198">        <span class="tok-comment">/// returns a matrix that filled with the given value</span></span>
<span class="line" id="L199">        <span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">fill</span>(arg: <span class="tok-type">f32</span>) *Self {</span>
<span class="line" id="L200">            <span class="tok-kw">var</span> self: *Self = defalutAllocator.create(Self) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;failed to create memory&quot;</span>);</span>
<span class="line" id="L201">            self.val = [_]RowType{.{arg} ** col} ** row;</span>
<span class="line" id="L202">            <span class="tok-kw">return</span> self;</span>
<span class="line" id="L203">        }</span>
<span class="line" id="L204">        <span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">from_array</span>(input: [row]RowType) *Self {</span>
<span class="line" id="L205">            <span class="tok-kw">var</span> self: *Self = defalutAllocator.create(Self) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;failed to create memory&quot;</span>);</span>
<span class="line" id="L206">            self.val = input;</span>
<span class="line" id="L207">            <span class="tok-kw">return</span> self;</span>
<span class="line" id="L208">        }</span>
<span class="line" id="L209">        <span class="tok-comment">/// print to the console</span></span>
<span class="line" id="L210">        <span class="tok-comment">/// for example, a 4x4 matrix created by default will be format like:</span></span>
<span class="line" id="L211">        <span class="tok-comment">/// Matrix4x4:</span></span>
<span class="line" id="L212">        <span class="tok-comment">/// { 0.0e+00, 0.0e+00, 0.0e+00, 0.0e+00 }</span></span>
<span class="line" id="L213">        <span class="tok-comment">/// { 0.0e+00, 0.0e+00, 0.0e+00, 0.0e+00 }</span></span>
<span class="line" id="L214">        <span class="tok-comment">/// { 0.0e+00, 0.0e+00, 0.0e+00, 0.0e+00 }</span></span>
<span class="line" id="L215">        <span class="tok-comment">/// { 0.0e+00, 0.0e+00, 0.0e+00, 0.0e+00 }</span></span>
<span class="line" id="L216">        <span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">print</span>(self: *Self) <span class="tok-type">void</span> {</span>
<span class="line" id="L217">            std.debug.print(<span class="tok-str">&quot;Matrix{d}x{d}: \n&quot;</span>, .{ row, col });</span>
<span class="line" id="L218">            <span class="tok-kw">for</span> (self.val) |row_| {</span>
<span class="line" id="L219">                std.debug.print(<span class="tok-str">&quot;{}\n&quot;</span>, .{row_});</span>
<span class="line" id="L220">            }</span>
<span class="line" id="L221">        }</span>
<span class="line" id="L222">        <span class="tok-comment">/// deinit a matrix</span></span>
<span class="line" id="L223">        <span class="tok-comment">/// matrix created by functions inside this type will all be valid to use this</span></span>
<span class="line" id="L224">        <span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">deinit</span>(self: *Self) <span class="tok-type">void</span> {</span>
<span class="line" id="L225">            defalutAllocator.destroy(self);</span>
<span class="line" id="L226">        }</span>
<span class="line" id="L227">        <span class="tok-comment">/// get the row size</span></span>
<span class="line" id="L228">        <span class="tok-comment">/// actually the size is static and is defined by yourself</span></span>
<span class="line" id="L229">        <span class="tok-comment">/// so you actually don't need this function do you</span></span>
<span class="line" id="L230">        <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">row_size</span>() <span class="tok-type">comptime_int</span> {</span>
<span class="line" id="L231">            <span class="tok-kw">return</span> row;</span>
<span class="line" id="L232">        }</span>
<span class="line" id="L233">        <span class="tok-comment">/// get the col size</span></span>
<span class="line" id="L234">        <span class="tok-comment">/// actually the size is static and is defined by yourself</span></span>
<span class="line" id="L235">        <span class="tok-comment">/// so you actually don't need this function do you</span></span>
<span class="line" id="L236">        <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">col_size</span>() <span class="tok-type">comptime_int</span> {</span>
<span class="line" id="L237">            <span class="tok-kw">return</span> col;</span>
<span class="line" id="L238">        }</span>
<span class="line" id="L239">        <span class="tok-comment">/// get the given index of column</span></span>
<span class="line" id="L240">        <span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">get_col</span>(self: *Self, col_index: <span class="tok-type">usize</span>) ColVector {</span>
<span class="line" id="L241">            <span class="tok-kw">if</span> (col_index &gt;= col) <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;index out of range&quot;</span>);</span>
<span class="line" id="L242">            <span class="tok-kw">var</span> res = init: {</span>
<span class="line" id="L243">                <span class="tok-kw">var</span> ptr: [row]T = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L244">                <span class="tok-kw">for</span> (&amp;ptr, <span class="tok-number">0</span>..) |*p, i| {</span>
<span class="line" id="L245">                    p.* = self.val[i][col_index];</span>
<span class="line" id="L246">                }</span>
<span class="line" id="L247">                <span class="tok-kw">break</span> :init ptr;</span>
<span class="line" id="L248">            };</span>
<span class="line" id="L249">            <span class="tok-kw">return</span> res;</span>
<span class="line" id="L250">        }</span>
<span class="line" id="L251">        <span class="tok-comment">/// get the given index of the row</span></span>
<span class="line" id="L252">        <span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">get_row</span>(self: *Self, row_index: <span class="tok-type">usize</span>) RowType {</span>
<span class="line" id="L253">            <span class="tok-kw">if</span> (row_index &gt;= row) <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;index out of range&quot;</span>);</span>
<span class="line" id="L254">            <span class="tok-kw">return</span> self.val[row_index];</span>
<span class="line" id="L255">        }</span>
<span class="line" id="L256">        <span class="tok-comment">/// add calculation for matrix</span></span>
<span class="line" id="L257">        <span class="tok-comment">/// will create a new matrix for result</span></span>
<span class="line" id="L258">        <span class="tok-comment">/// if you want to add to this matrix, using add_assign instead</span></span>
<span class="line" id="L259">        <span class="tok-comment">/// this opration is not checked, may overflow the number limit</span></span>
<span class="line" id="L260">        <span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">add</span>(self: *Self, rhs: *Self) *Self {</span>
<span class="line" id="L261">            <span class="tok-kw">var</span> res = Self.default();</span>
<span class="line" id="L262">            <span class="tok-kw">var</span> i: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L263">            <span class="tok-kw">while</span> (i &lt; row) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L264">                res.val[i] = self.val[i] + rhs.val[i];</span>
<span class="line" id="L265">            }</span>
<span class="line" id="L266">            <span class="tok-kw">return</span> res;</span>
<span class="line" id="L267">        }</span>
<span class="line" id="L268">        <span class="tok-comment">/// add assignment opration for matrix</span></span>
<span class="line" id="L269">        <span class="tok-comment">/// this opration is not checked, may overflow the number limit</span></span>
<span class="line" id="L270">        <span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">add_assign</span>(self: *Self, rhs: *Self) <span class="tok-type">void</span> {</span>
<span class="line" id="L271">            <span class="tok-kw">var</span> i: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L272">            <span class="tok-kw">while</span> (i &lt; row) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L273">                self.val[i] += rhs.val[i];</span>
<span class="line" id="L274">            }</span>
<span class="line" id="L275">        }</span>
<span class="line" id="L276">        <span class="tok-comment">/// reduce calculation for matrix</span></span>
<span class="line" id="L277">        <span class="tok-comment">/// will create a new matrix for result</span></span>
<span class="line" id="L278">        <span class="tok-comment">/// if you want to reduce from this matrix, using reduce_assign instead</span></span>
<span class="line" id="L279">        <span class="tok-comment">/// this opration is not checked, may overflow the number limit</span></span>
<span class="line" id="L280">        <span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">reduce</span>(self: *Self, rhs: *Self) *Self {</span>
<span class="line" id="L281">            <span class="tok-kw">var</span> res = Self.default();</span>
<span class="line" id="L282">            <span class="tok-kw">var</span> i: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L283">            <span class="tok-kw">while</span> (i &lt; row) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L284">                res.val[i] = self.val[i] - rhs.val[i];</span>
<span class="line" id="L285">            }</span>
<span class="line" id="L286">            <span class="tok-kw">return</span> res;</span>
<span class="line" id="L287">        }</span>
<span class="line" id="L288">        <span class="tok-comment">/// reduce assignment opration for matrix</span></span>
<span class="line" id="L289">        <span class="tok-comment">/// this opration is not checked, may overflow the number limit</span></span>
<span class="line" id="L290">        <span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">reduce_assign</span>(self: *Self, rhs: *Self) <span class="tok-type">void</span> {</span>
<span class="line" id="L291">            <span class="tok-kw">var</span> i: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L292">            <span class="tok-kw">while</span> (i &lt; row) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L293">                self.val[i] -= rhs.val[i];</span>
<span class="line" id="L294">            }</span>
<span class="line" id="L295">        }</span>
<span class="line" id="L296">        <span class="tok-comment">/// because of zig's trait design</span></span>
<span class="line" id="L297">        <span class="tok-comment">/// it is not that convenient to define a trait for Matrix type</span></span>
<span class="line" id="L298">        <span class="tok-comment">/// and valid type for mul is the Matrix which's col is the same size of this matrix</span></span>
<span class="line" id="L299">        <span class="tok-comment">/// the row size is not known at compile time</span></span>
<span class="line" id="L300">        <span class="tok-comment">/// using anytype here is not recommended, but I running out of solutions</span></span>
<span class="line" id="L301">        <span class="tok-comment">/// the return type is a little be weird, but actually valid</span></span>
<span class="line" id="L302">        <span class="tok-comment">/// this function could not be inline because of the multiplication for Matrix is recursive</span></span>
<span class="line" id="L303">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">mul</span>(self: *Self, rhs: <span class="tok-kw">anytype</span>) return_type: {</span>
<span class="line" id="L304">            <span class="tok-kw">if</span> (<span class="tok-builtin">@TypeOf</span>(rhs) == RowType) <span class="tok-kw">break</span> :return_type ColVector;</span>
<span class="line" id="L305">            <span class="tok-kw">break</span> :return_type *Matrix(row, <span class="tok-builtin">@typeInfo</span>(<span class="tok-builtin">@TypeOf</span>(rhs)).Pointer.child.col_size(), T);</span>
<span class="line" id="L306">        } {</span>
<span class="line" id="L307">            <span class="tok-kw">if</span> (<span class="tok-builtin">@TypeOf</span>(rhs) == RowType) {</span>
<span class="line" id="L308">                <span class="tok-kw">var</span> res: ColVector = init: {</span>
<span class="line" id="L309">                    <span class="tok-kw">var</span> ptr: [row]T = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L310">                    <span class="tok-kw">for</span> (&amp;ptr, <span class="tok-number">0</span>..) |*p, i| {</span>
<span class="line" id="L311">                        p.* = dot(Vector{ .row = self.get_row(i) }, Vector{ .row = rhs });</span>
<span class="line" id="L312">                    }</span>
<span class="line" id="L313">                    <span class="tok-kw">break</span> :init ptr;</span>
<span class="line" id="L314">                };</span>
<span class="line" id="L315">                <span class="tok-kw">return</span> res;</span>
<span class="line" id="L316">            }</span>
<span class="line" id="L317">            <span class="tok-kw">if</span> (isValidMulMatrix(<span class="tok-builtin">@TypeOf</span>(rhs))) {</span>
<span class="line" id="L318">                <span class="tok-kw">var</span> res: *Matrix(row, <span class="tok-builtin">@typeInfo</span>(<span class="tok-builtin">@TypeOf</span>(rhs)).Pointer.child.col_size(), T) = init: {</span>
<span class="line" id="L319">                    <span class="tok-kw">var</span> array: [row]<span class="tok-builtin">@Vector</span>(<span class="tok-builtin">@typeInfo</span>(<span class="tok-builtin">@TypeOf</span>(rhs)).Pointer.child.col_size(), T) = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L320">                    <span class="tok-kw">for</span> (&amp;array, <span class="tok-number">0</span>..) |*p, i| {</span>
<span class="line" id="L321">                        p.* = self.mul(rhs.get_col(i));</span>
<span class="line" id="L322">                    }</span>
<span class="line" id="L323">                    <span class="tok-kw">break</span> :init Self.from_array(array);</span>
<span class="line" id="L324">                };</span>
<span class="line" id="L325">                <span class="tok-kw">return</span> res;</span>
<span class="line" id="L326">            }</span>
<span class="line" id="L327">            <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;not a valid type&quot;</span>);</span>
<span class="line" id="L328">        }</span>
<span class="line" id="L329">    };</span>
<span class="line" id="L330">}</span>
<span class="line" id="L331"><span class="tok-kw">test</span> <span class="tok-str">&quot;Matrix&quot;</span> {</span>
<span class="line" id="L332">    <span class="tok-kw">var</span> m1 = Matrix(<span class="tok-number">4</span>, <span class="tok-number">4</span>, <span class="tok-type">f32</span>).init(.{ .{ <span class="tok-number">1</span>, <span class="tok-number">2</span>, <span class="tok-number">3</span>, <span class="tok-number">4</span> }, .{ <span class="tok-number">1</span>, <span class="tok-number">2</span>, <span class="tok-number">3</span>, <span class="tok-number">4</span> }, .{ <span class="tok-number">1</span>, <span class="tok-number">2</span>, <span class="tok-number">3</span>, <span class="tok-number">4</span> }, .{ <span class="tok-number">1</span>, <span class="tok-number">2</span>, <span class="tok-number">3</span>, <span class="tok-number">4</span> } });</span>
<span class="line" id="L333">    <span class="tok-kw">defer</span> m1.deinit();</span>
<span class="line" id="L334">    m1.print();</span>
<span class="line" id="L335">    <span class="tok-kw">var</span> m2 = Matrix(<span class="tok-number">4</span>, <span class="tok-number">4</span>, <span class="tok-type">f32</span>).init(.{ <span class="tok-number">1</span>, <span class="tok-number">2</span>, <span class="tok-number">3</span>, <span class="tok-number">4</span>, <span class="tok-number">1</span>, <span class="tok-number">2</span>, <span class="tok-number">3</span>, <span class="tok-number">4</span>, <span class="tok-number">1</span>, <span class="tok-number">2</span>, <span class="tok-number">3</span>, <span class="tok-number">4</span>, <span class="tok-number">1</span>, <span class="tok-number">2</span>, <span class="tok-number">3</span>, <span class="tok-number">4</span> });</span>
<span class="line" id="L336">    <span class="tok-kw">defer</span> m2.deinit();</span>
<span class="line" id="L337">    std.log.warn(<span class="tok-str">&quot;{d}&quot;</span>, .{m2.val.len});</span>
<span class="line" id="L338">    m2.print();</span>
<span class="line" id="L339">    <span class="tok-kw">var</span> m3 = m1.add(m2);</span>
<span class="line" id="L340">    <span class="tok-kw">defer</span> m3.deinit();</span>
<span class="line" id="L341">    std.log.warn(<span class="tok-str">&quot;{d}&quot;</span>, .{m3.val.len});</span>
<span class="line" id="L342">    m3.print();</span>
<span class="line" id="L343">    m3.add_assign(m3);</span>
<span class="line" id="L344">    std.log.warn(<span class="tok-str">&quot;{d}&quot;</span>, .{m3.val.len});</span>
<span class="line" id="L345">    m3.print();</span>
<span class="line" id="L346">    <span class="tok-kw">var</span> m4 = m3.reduce(m2);</span>
<span class="line" id="L347">    <span class="tok-kw">defer</span> m4.deinit();</span>
<span class="line" id="L348">    m4.print();</span>
<span class="line" id="L349">    m4.reduce_assign(m3);</span>
<span class="line" id="L350">    m4.print();</span>
<span class="line" id="L351">    <span class="tok-kw">var</span> m5 = m3.mul(m4);</span>
<span class="line" id="L352">    <span class="tok-kw">defer</span> m5.deinit();</span>
<span class="line" id="L353">    m5.print();</span>
<span class="line" id="L354">    <span class="tok-kw">var</span> v1 = <span class="tok-builtin">@Vector</span>(<span class="tok-number">4</span>, <span class="tok-type">f32</span>){ <span class="tok-number">1</span>, <span class="tok-number">2</span>, <span class="tok-number">3</span>, <span class="tok-number">4</span> };</span>
<span class="line" id="L355">    <span class="tok-kw">var</span> v2 = m5.mul(v1);</span>
<span class="line" id="L356">    std.log.warn(<span class="tok-str">&quot;{}&quot;</span>, .{v2});</span>
<span class="line" id="L357">}</span>
<span class="line" id="L358"></span>
</code></pre></body>
</html>